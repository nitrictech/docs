export const description =
  'Deploy to AWS, Google Cloud or Microsoft Azure using GitLab CI and the Nitric CLI'

# Deployment Automation with GitLab CI and Nitric

This guide will demonstrate how Nitric can be used, along with [GitLab CI](https://docs.gitlab.com/ee/ci/), to create a continuous deployment pipeline. The actions in the example below target AWS, but can be modified to target Google Cloud or Microsoft Azure.

<Note>
  This guide assumes basic knowledge about GitLab CI. If you're new to the
  feature you could start by reviewing [GitLab's
  docs](https://docs.gitlab.com/ee/ci/)
</Note>

## Configuration

To begin you'll need a Nitric project ready to be deployed. If you haven't created a project yet, take a look at the [quickstart guide](/getting-started/quickstart).

Next, we'll add a GitLab CI workflow file to the project. This is where you'll configure the deployment automation steps. Create a yaml file `.gitlab-ci.yml` at the root of your project. The file can be named how you like, however `.gitlab-ci.yml` is most common.

Here is example content you can copy into your workflow file. In the next sections we'll breakdown what's happening in this file, so you can modify it as you see fit.

```yaml {{tag: '.gitlab-ci.yml'}}
deploy:
  image: docker:27

  # Enable Docker-in-Docker (DinD) to allow running Docker commands within the CI environment
  services:
    - docker:27-dind

  # Define rules for when this job should run
  rules:
    # Run this job only if the pipeline is triggered by a merge request event
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    # Run this job if the commit branch matches the default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

  # Set environment variables for Pulumi and AWS credentials
  variables:
    PULUMI_CONFIG_PASSPHRASE: $PULUMI_ACCESS_TOKEN
    PULUMI_ACCESS_TOKEN: $PULUMI_ACCESS_TOKEN
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY

  before_script:
    # Update package list and install required packages
    - apk update && apk add --no-cache curl bash

    # Retrieve the IP address of the Docker host, necessary for Docker-in-Docker communication
    - export NITRIC_DOCKER_HOST=$(ip -4 addr show eth0 | grep -o 'inet [0-9\.]*' | awk '{print $2}')

    # Install Pulumi by downloading and executing the installation script
    # Pulumi is a tool for managing infrastructure as code
    - curl -fsSL https://get.pulumi.com | sh
    - export PATH=$PATH:$HOME/.pulumi/bin

    # Install Nitric by downloading and executing the installation script
    - curl -L https://nitric.io/install?version=latest | bash
    - export PATH=$PATH:$HOME/.nitric/bin

  script:
    # Execute the Nitric command to deploy infrastructure
    # --ci flag is used for continuous integration environments
    - nitric up --ci
```
