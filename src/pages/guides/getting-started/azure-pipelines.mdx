export const description =
  'Deploy to AWS, Google Cloud or Microsoft Azure using Azure DevOps and the Nitric CLI'

### Deployment Automation with Azure Pipelines and Nitric

This guide will illustrate how Nitric can be integrated with Azure Pipelines to establish a continuous deployment pipeline. The example below focuses on AWS, but with minor adjustments, it can be adapted for Google Cloud or Microsoft Azure.

<Note>
  This guide assumes basic knowledge about Azure Pipelines. If you're
  unfamiliar, it's recommended to go through [Azure Pipelines
  documentation](https://docs.microsoft.com/en-us/azure/devops/pipelines/get-started/what-is-azure-pipelines)
  first.
</Note>

#### Pipeline Setup

Firstly, ensure you have a Nitric project prepared for deployment. If not, refer to Nitric's [quickstart guide](https://nitric.io/docs/).

Then, you'll need to create an Azure Pipelines YAML file for your project. This will dictate the automated deployment steps. Let's name this file `azure-pipelines.yml`.

Below is the example content for your pipeline file. We'll explain each segment afterward, allowing you to adjust as needed:

```yaml
trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  - script: |
      npm install
    displayName: 'npm install and build'

  - script: |
      # Install Pulumi
      curl -fsSL https://get.pulumi.com | sh
      # Export path for pulumi (assuming default installation path)
      export PATH=$PATH:$HOME/.pulumi/bin
      pulumi version

      # Install Nitric
      curl https://nitric.io/install | bash
      export PATH=$PATH:$HOME/.nitric/bin
      nitric up --ci
    displayName: 'Install Pulumi and Nitric'
    env:
      PULUMI_CONFIG_PASSPHRASE: $(PULUMI_CONFIG_PASSPHRASE)
      PULUMI_ACCESS_TOKEN: $(PULUMI_ACCESS_TOKEN)
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_REGION: 'us-east-1'
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
```

## Breaking it down

### Pipeline Triggers

Triggers indicate when the pipeline should execute:

```yaml
trigger:
  - main
```

The above config will activate the pipeline each time there's a commit to the main branch.

### Virtual Machine Image

Define the [virtual machine image](https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=yaml) on which the pipeline runs:

```yaml
pool:
  vmImage: ubuntu-latest
```

### Installing Node.js

The next step is to install Node.js, a requirement for many modern web projects:

```yaml
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'
```

### Installing Dependencies

Use the following step to install project dependencies for your project, we used `npm install` here for a node project:

```yaml
- script: |
    npm install
  displayName: 'npm install and build'
```

### Pulumi and Nitric Setup

Install Pulumi and Nitric, which are necessary for deployment and set the relevant environment paths:

```yaml
- script: |
  - script: |
      # Install Pulumi
      curl -fsSL https://get.pulumi.com | sh
      # Export path for pulumi (assuming default installation path)
      export PATH=$PATH:$HOME/.pulumi/bin
      pulumi version

      # Install Nitric
      curl https://nitric.io/install | bash
      export PATH=$PATH:$HOME/.nitric/bin
      nitric up --ci
  displayName: 'Install Pulumi and Nitric'
  env:
      PULUMI_CONFIG_PASSPHRASE: $(PULUMI_CONFIG_PASSPHRASE)
      PULUMI_ACCESS_TOKEN: $(PULUMI_ACCESS_TOKEN)
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_REGION: 'us-east-1'
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
```

To set up these secrets, navigate to the Azure Pipelines dashboard, select your pipeline, and add new secrets under the 'Variables' section.

> Note: Environment variables like api keys should be stored securely in Azure Pipelines secrets. These secrets are encrypted and can only be accessed by pipelines running in the same Azure DevOps project.

With the pipeline established, each commit to the main branch will trigger an automated deployment using Nitric.

Adjustments can be made to target different cloud platforms or to integrate additional stages and tools as required.
